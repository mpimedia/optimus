#!/usr/bin/env bash

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}=== Package Update Script ===${NC}"

# Ensure we're on the main branch and up to date
echo -e "${YELLOW}Checking current branch...${NC}"
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "main" ]; then
  echo -e "${RED}Please run this script from the main branch${NC}"
  exit 1
fi

echo -e "${YELLOW}Pulling latest changes...${NC}"
git pull origin main

# Set yarn version to berry
echo -e "${YELLOW}Setting yarn version to berry...${NC}"
yarn set version berry

# Check for outdated packages and capture output
echo -e "${YELLOW}Checking for outdated packages...${NC}"
OUTDATED_OUTPUT=$(yarn outdated 2>&1 || true)
echo "$OUTDATED_OUTPUT"

# Check if there are outdated dependencies (Yarn 4 format: "X dependency is out of date" or "X dependencies are out of date")
if echo "$OUTDATED_OUTPUT" | grep -q "is out of date\|are out of date"; then
  # Parse outdated packages from Yarn 4 output (look for lines with package names after the header)
  OUTDATED_PACKAGES=$(echo "$OUTDATED_OUTPUT" | grep -E "^➤ YN0000: [a-zA-Z@]" | grep -v "Package\|Done\|Checking\|Completed" | awk '{print $3}' || true)
else
  echo -e "${GREEN}✓ No package updates needed. All packages are up to date!${NC}"
  exit 0
fi

if [ -z "$OUTDATED_PACKAGES" ]; then
  echo -e "${GREEN}✓ No package updates needed. All packages are up to date!${NC}"
  exit 0
fi

echo -e "${YELLOW}Outdated packages found:${NC}"
echo "$OUTDATED_PACKAGES"

# Create branch name with date and time
BRANCH_NAME="chore/update-packages-$(date +%Y-%m-%d-%H%M%S)"

echo -e "${YELLOW}Creating branch: ${BRANCH_NAME}${NC}"
git checkout -b "$BRANCH_NAME"

# Capture package versions before update
echo -e "${YELLOW}Capturing current package versions...${NC}"
BEFORE_VERSIONS=$(cat package.json)

# Update all outdated packages to exact versions
echo -e "${YELLOW}Updating packages...${NC}"
for pkg in $OUTDATED_PACKAGES; do
  echo -e "${YELLOW}Updating $pkg...${NC}"
  # Use --exact to pin the exact version (no ^ or ~ prefix)
  yarn up "$pkg" --exact
done

# Check if package.json changed
if git diff --quiet package.json yarn.lock 2>/dev/null; then
  echo -e "${GREEN}✓ No actual changes to package.json or yarn.lock. All packages are already at latest versions.${NC}"
  git checkout main
  git branch -D "$BRANCH_NAME"
  exit 0
fi

# Generate changelog of updates
echo -e "${YELLOW}Generating changelog...${NC}"
CHANGES=$(git diff package.json | grep -E "^\+" | grep -v "^\+\+\+" | sed 's/^\+//' || true)

# Build PR body
PR_TITLE="chore: Update npm packages ($(date +%Y-%m-%d))"
PR_BODY="## Package Updates

This PR updates the following npm packages:

### Changes to package.json
\`\`\`diff
$(git diff package.json)
\`\`\`

### Updated packages
$(echo "$OUTDATED_PACKAGES" | while read pkg; do
  if [ -n "$pkg" ]; then
    echo "- $pkg"
  fi
done)

---
*Generated automatically by \`bin/update-packages\`*"

# Commit changes
echo -e "${YELLOW}Committing changes...${NC}"
git add package.json yarn.lock .yarn/ .yarnrc.yml 2>/dev/null || true
git commit -m "$PR_TITLE"

# Push branch
echo -e "${YELLOW}Pushing branch to GitHub...${NC}"
git push -u origin "$BRANCH_NAME"

# Create pull request using GitHub CLI
if command -v gh &> /dev/null; then
  echo -e "${YELLOW}Creating pull request...${NC}"
  gh pr create \
    --title "$PR_TITLE" \
    --body "$PR_BODY" \
    --base main \
    --head "$BRANCH_NAME"
  
  echo -e "${GREEN}✓ Pull request created successfully!${NC}"
else
  echo -e "${RED}GitHub CLI (gh) not installed. Please create the PR manually.${NC}"
  echo -e "${YELLOW}Branch pushed: ${BRANCH_NAME}${NC}"
  echo ""
  echo "PR Title: $PR_TITLE"
  echo ""
  echo "PR Body:"
  echo "$PR_BODY"
fi

echo -e "${GREEN}=== Package update complete! ===${NC}"
